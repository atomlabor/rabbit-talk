
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rabbit-talk</title>
    <!-- Tailwind CSS CDN für einfache und schnelle Gestaltung -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .chat-container {
            height: calc(100vh - 12rem); /* Dynamische Höhe für den Nachrichtenbereich */
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE und Edge */
        }
        .chat-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* Stil für Bildnachrichten */
        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        /* Touch-freundliche Styles für Buttons und Inputs */
        .btn-touch {
            min-width: 48px;
            min-height: 48px;
            padding: 12px;
            border-radius: 12px;
        }
        .input-touch {
            min-height: 48px;
            padding: 12px;
            border-radius: 12px;
        }
        #language-selector {
            min-width: 48px;
            min-height: 48px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 1.5em;
        }
    </style>
</head>
<body class="flex flex-col h-screen p-4 sm:p-6 lg:p-8">
    <div class="flex-grow flex flex-col max-w-lg mx-auto w-full">
        <!-- App-Titel und Benutzer-ID -->
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 id="app-title" class="text-3xl font-bold"></h1>
                <p class="text-xs text-gray-400">atomlabor.de creations</p>
            </div>
            <div class="flex items-center space-x-2">
                <p id="user-display-name" class="text-sm text-gray-400 truncate"></p>
                <select id="language-selector" class="p-1 rounded-md bg-[#2a2a2a] text-sm text-gray-300 border-gray-600 btn-touch">
                    <option value="de">Deutsch</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>

        <!-- Nachrichtenbereich -->
        <div id="messages" class="chat-container flex-grow p-4 bg-[#2a2a2a] rounded-xl shadow-lg mb-4 space-y-4">
            <div id="status-message" class="text-center text-gray-500"></div>
        </div>

        <!-- Eingabebereich -->
        <form id="message-form" class="flex items-center space-x-2">
            <input type="text" id="message-input"
                   class="flex-grow p-3 rounded-lg bg-[#3a3a3a] text-white focus:outline-none focus:ring-2 focus:ring-[rgb(255,93,2)] border-2 border-transparent focus:border-[rgb(255,93,2)] transition-all duration-200 input-touch"
                   autocomplete="off">
            <label for="image-upload" class="cursor-pointer bg-[rgb(255,93,2)] hover:bg-[rgb(255,103,12)] active:bg-[rgb(255,83,0)] text-white rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 btn-touch" title="Bild hochladen">
                <i class="fas fa-image"></i>
            </label>
            <input type="file" id="image-upload" class="hidden" accept="image/*">
            <button type="submit" id="send-btn"
                    class="bg-[rgb(255,93,2)] hover:bg-[rgb(255,103,12)] active:bg-[rgb(255,83,0)] text-white rounded-lg font-semibold shadow-md transition-all duration-200 transform hover:scale-105 btn-touch">
            </button>
        </form>
    </div>

    <!-- Benutzername Modal -->
    <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-[#2a2a2a] p-8 rounded-lg shadow-lg w-96">
            <h2 id="modal-title" class="text-xl font-bold text-center mb-4"></h2>
            <input type="text" id="name-input"
                   class="w-full p-3 rounded-lg bg-[#3a2a2a] text-white focus:outline-none focus:ring-2 focus:ring-[rgb(255,93,2)] mb-4 input-touch"
                   maxlength="20">
            <button id="save-name-btn" class="w-full p-3 bg-[rgb(255,93,2)] hover:bg-[rgb(255,103,12)] active:bg-[rgb(255,83,0)] text-white rounded-lg font-semibold shadow-md btn-touch">
            </button>
        </div>
    </div>
    
    <!-- Meldungsbox -->
    <div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-xl hidden transition-opacity duration-300 z-50"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // Die folgenden Platzhalter werden von GitHub Actions während des Deployments ersetzt.
        // Fügen Sie diese nicht manuell ein!
        const firebaseConfig = {
            apiKey: "AIzaSyAPXLn4vy3ta4-VjwMLlBcHZNp7fiuQxvQ",
            authDomain: "rabbit-talk-5c709.firebaseapp.com",
            projectId: "rabbit-talk-5c709",
            storageBucket: "rabbit-talk-5c709.firebasestorage.app",
            messagingSenderId: "337187471571",
            appId: "1:337187471571:web:4e7449b2a6c4b4b25e9426"
        };
        
        // Verwende die bereitgestellte App-ID, um sicherzustellen, dass die App funktioniert.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        console.log("Firebase-Konfiguration geladen:", firebaseConfig);

        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const imageUpload = document.getElementById('image-upload');
        const userDisplayName = document.getElementById('user-display-name');
        const statusMessage = document.getElementById('status-message');
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        const languageSelector = document.getElementById('language-selector');
        const messageBox = document.getElementById('message-box');

        // Der Anzeigename wird im Browser-Speicher gespeichert, damit er bei der nächsten Sitzung erhalten bleibt.
        let displayName = localStorage.getItem('chatDisplayName') || '';

        // Mehrsprachige Übersetzungen
        const translations = {
            de: {
                app_title: 'rabbit-talk',
                user_status_id: 'Ihre ID: ',
                user_status_name: 'Angemeldet als: ',
                status_connecting: 'Verbinde...',
                message_placeholder: 'Nachricht eingeben...',
                send_btn: 'Senden',
                modal_title: 'Wähle einen Chat-Namen',
                modal_placeholder: 'Name eingeben...',
                save_btn: 'Speichern',
                report_message: 'Diese Nachricht wurde gemeldet. Danke für Ihre Mithilfe!',
                error_sending: 'Nachricht konnte nicht gesendet werden.',
                login_error: 'Fehler bei der Anmeldung. Bitte lade die Seite neu.',
                auth_config_error: 'Anmeldefehler: Firebase-Authentifizierung ist in Ihrem Projekt nicht aktiviert. Bitte überprüfen Sie die Einstellungen in der Firebase-Konsole.',
                auth_api_key_error: 'Fehler beim Laden des Firebase API-Schlüssels. Bitte überprüfen Sie, ob der "FIREBASE_API_KEY"-Secret in Ihrem GitHub-Repository korrekt eingerichtet ist.',
                your_name: 'Du',
                enter_name_alert: 'Bitte geben Sie einen Namen ein.'
            },
            en: {
                app_title: 'rabbit-talk',
                user_status_id: 'Your ID: ',
                user_status_name: 'Logged in as: ',
                status_connecting: 'Connecting...',
                message_placeholder: 'Enter a message...',
                send_btn: 'Send',
                modal_title: 'Choose a Chat Name',
                modal_placeholder: 'Enter name...',
                save_btn: 'Save',
                report_message: 'This message has been reported. Thank you for your help!',
                error_sending: 'Could not send message.',
                login_error: 'Error logging in. Please reload the page.',
                auth_config_error: 'Login error: Firebase Authentication is not enabled in your project. Please check the settings in the Firebase console.',
                auth_api_key_error: 'Firebase API key failed to load. Please verify that the "FIREBASE_API_KEY" secret in your GitHub repository is correctly configured.',
                your_name: 'You',
                enter_name_alert: 'Please enter a name.'
            }
        };

        let currentLang = localStorage.getItem('chatLanguage') || 'de';

        // Funktion zur Anzeige von temporären Meldungen
        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // Funktion zur Aktualisierung der Sprache
        function updateLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('chatLanguage', lang);
            const t = translations[lang];

            // UI-Elemente aktualisieren
            document.getElementById('app-title').textContent = t.app_title;
            messageInput.placeholder = t.message_placeholder;
            document.getElementById('send-btn').textContent = t.send_btn;
            document.getElementById('modal-title').textContent = t.modal_title;
            nameInput.placeholder = t.modal_placeholder;
            document.getElementById('save-name-btn').textContent = t.save_btn;
            statusMessage.textContent = t.status_connecting;
            
            // Benutzer-Status-Text aktualisieren
            if (displayName) {
                userDisplayName.textContent = t.user_status_name + displayName;
            } else if (auth.currentUser) {
                userDisplayName.textContent = t.user_status_id + auth.currentUser.uid;
            }
        }
        
        // Sprache beim Laden initialisieren
        languageSelector.value = currentLang;
        updateLanguage(currentLang);
        
        languageSelector.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        // Funktion zum Anzeigen von Nachrichten
        function displayMessage(message, isMe) {
            const t = translations[currentLang];
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'flex-col', 'rounded-lg', 'p-3', 'max-w-[75%]', 'break-words', 'shadow-md', 'relative');
            
            if (isMe) {
                messageElement.classList.add('self-end', 'bg-[rgb(255,93,2)]');
            } else {
                messageElement.classList.add('self-start', 'bg-[#3a3a3a]');
            }

            const senderName = message.displayName || `${t.user_status_id}${message.senderId}`;
            const senderIdElement = document.createElement('span');
            senderIdElement.classList.add('text-xs', 'font-bold', 'mb-1', 'text-gray-300');
            senderIdElement.textContent = isMe ? t.your_name : senderName;
            
            messageElement.appendChild(senderIdElement);

            if (message.text) {
                const textElement = document.createElement('span');
                textElement.classList.add('text-white', 'text-base');
                textElement.textContent = message.text;
                messageElement.appendChild(textElement);
            }

            if (message.image) {
                const imageElement = document.createElement('img');
                imageElement.classList.add('message-image');
                imageElement.src = message.image;
                imageElement.loading = 'lazy'; // Bild-Laden optimieren
                messageElement.appendChild(imageElement);
            }

            // Moderationsbuttons
            const actionsContainer = document.createElement('div');
            actionsContainer.classList.add('absolute', 'top-0', 'flex', 'space-x-1', 'p-1', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity');
            
            if (isMe) {
                actionsContainer.classList.add('right-0');
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('text-red-400', 'hover:text-red-600');
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                deleteButton.title = 'Löschen';
                // Die Löschfunktion wird nur ausgelöst, wenn der Benutzer der Autor der Nachricht ist
                if (message.senderId === auth.currentUser.uid) {
                    deleteButton.addEventListener('click', () => deleteMessage(message.docId));
                }
                actionsContainer.appendChild(deleteButton);
            } else {
                actionsContainer.classList.add('left-0');
                const reportButton = document.createElement('button');
                reportButton.classList.add('text-yellow-400', 'hover:text-yellow-600');
                reportButton.innerHTML = '<i class="fas fa-flag"></i>';
                reportButton.title = 'Melden';
                reportButton.addEventListener('click', () => reportMessage(message.docId));
                actionsContainer.appendChild(reportButton);
            }

            messageElement.classList.add('group');
            messageElement.appendChild(actionsContainer);
            messagesContainer.appendChild(messageElement);
        }

        // Funktion zum Löschen einer Nachricht
        async function deleteMessage(docId) {
            try {
                // Pfad wurde auf den öffentlichen Pfad geändert
                const messageRef = doc(db, `artifacts/${appId}/public/data/messages`, docId);
                await deleteDoc(messageRef);
                console.log(`Nachricht ${docId} gelöscht.`);
            } catch (error) {
                console.error("Fehler beim Löschen der Nachricht:", error);
            }
        }

        // Funktion zum Melden einer Nachricht (Platzhalter)
        function reportMessage(docId) {
            console.log(`Nachricht ${docId} wurde gemeldet. In einer realen App würde dies an ein Moderationsteam gesendet.`);
            showMessage(translations[currentLang].report_message);
        }

        // Live-Update von Nachrichten
        function listenForMessages() {
            // Pfad wurde auf den öffentlichen Pfad geändert, um einen Gruppenchat zu ermöglichen
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            let isInitialLoad = true;
            // Der orderBy-Teil wurde entfernt, um Berechtigungsfehler zu vermeiden
            const q = query(collection(db, messagesCollectionPath));

            onSnapshot(q, (snapshot) => {
                // Prüfen, ob eine neue Nachricht hinzugefügt wurde
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && !isInitialLoad) {
                        const newMessage = change.doc.data();
                        // Vibrationsfunktion nur auslösen, wenn die Nachricht von einem anderen Benutzer kommt
                        if (navigator.vibrate && newMessage.senderId !== auth.currentUser.uid) {
                            navigator.vibrate(200); // Vibriert für 200ms
                        }
                    }
                });

                // Nachrichtencontainer leeren und neu befüllen
                messagesContainer.innerHTML = '';
                
                if (statusMessage) {
                    statusMessage.remove();
                }

                let messages = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                // Sortieren der Nachrichten nach dem Zeitstempel im Code, um den Index-Fehler zu vermeiden
                messages.sort((a, b) => a.timestamp - b.timestamp);

                messages.forEach(message => {
                    displayMessage(message, message.senderId === auth.currentUser.uid);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                isInitialLoad = false;
            }, (error) => {
                console.error("Fehler beim Abrufen der Nachrichten:", error);
                const t = translations[currentLang];
                if (statusMessage) {
                    statusMessage.textContent = `${t.login_error} - ${error.code}`;
                }
            });
        }

        // Benutzerauthentifizierung
        onAuthStateChanged(auth, async (user) => {
            const t = translations[currentLang];
            if (user) {
                console.log("Benutzer angemeldet:", user.uid);
                if (displayName) {
                    userDisplayName.textContent = t.user_status_name + displayName;
                } else {
                    // Da ein Anzeigename erforderlich ist, öffnen Sie das Modal, wenn der Benutzer angemeldet ist, aber keinen Namen hat.
                    userDisplayName.textContent = t.user_status_id + user.uid;
                    nameModal.classList.remove('hidden');
                }
                
                // Live-Update von Nachrichten starten, nachdem der Benutzer angemeldet ist
                listenForMessages();
            } else {
                console.log("Kein Benutzer angemeldet. Melde anonym an...");
                try {
                    // Überprüfen, ob Firebase-Platzhalter vorhanden sind, was auf einen fehlerhaften GitHub Actions-Workflow hinweist.
                    if (firebaseConfig.apiKey.includes("FIREBASE_API_KEY")) {
                         if (statusMessage) {
                            statusMessage.textContent = t.auth_api_key_error;
                        }
                        console.error(t.auth_api_key_error);
                        return; // Beenden, um weitere Fehler zu vermeiden
                    }
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Mit benutzerdefiniertem Token angemeldet.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Anonym angemeldet.");
                    }

                } catch (error) {
                    console.error("Fehler bei der Anmeldung:", error);
                    if (error.code === 'auth/configuration-not-found') {
                        if (statusMessage) {
                             statusMessage.textContent = t.auth_config_error;
                        }
                    } else if (error.code === 'auth/invalid-api-key') {
                         if (statusMessage) {
                            statusMessage.textContent = t.auth_api_key_error;
                        }
                    }
                    else {
                        if (statusMessage) {
                            statusMessage.textContent = t.login_error;
                        }
                    }
                }
            }
        });

        // Event-Listener für das Benutzernamen-Modal
        saveNameBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const t = translations[currentLang];
            if (name) {
                displayName = name;
                localStorage.setItem('chatDisplayName', name);
                userDisplayName.textContent = t.user_status_name + displayName;
                nameModal.classList.add('hidden');
            } else {
                showMessage(t.enter_name_alert);
            }
        });

        // Nachrichten oder Bilder senden
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            const t = translations[currentLang];
            
            let messageData = {};

            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = async function() {
                    messageData = {
                        text: text, // Sende auch den Text, wenn ein Bild hochgeladen wird
                        image: reader.result,
                        senderId: auth.currentUser.uid,
                        displayName: displayName,
                        timestamp: serverTimestamp()
                    };
                    await addMessageToFirestore(messageData);
                }
                reader.readAsDataURL(file);
                messageInput.value = '';
                imageUpload.value = '';
            } else if (text.length > 0) {
                messageData = {
                    text: text,
                    senderId: auth.currentUser.uid,
                    displayName: displayName,
                    timestamp: serverTimestamp()
                };
                await addMessageToFirestore(messageData);
                messageInput.value = '';
            }
        });

        async function addMessageToFirestore(data) {
            // Pfad wurde auf den öffentlichen Pfad geändert, um einen Gruppenchat zu ermöglichen
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            try {
                await addDoc(collection(db, messagesCollectionPath), data);
            } catch (error) {
                console.error("Fehler beim Senden der Nachricht:", error);
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('text-red-500', 'text-center', 'text-sm', 'mt-2');
                errorMessage.textContent = translations[currentLang].error_sending;
                messagesContainer.appendChild(errorMessage);
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.activeElement === messageInput) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });

    </script>
</body>
</html>
