<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rabbit-talk</title>
    <!-- Tailwind CSS CDN für einfache und schnelle Gestaltung -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .chat-container {
            height: calc(100vh - 12rem); /* Dynamische Höhe für den Nachrichtenbereich */
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE und Edge */
        }
        .chat-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* Stil für Bildnachrichten */
        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Touch-freundliche Styles für Buttons und Inputs */
        .btn-touch {
            min-width: 48px;
            min-height: 48px;
        }
        
        /* Animationen für bessere UX */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile-optimierte Styles */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .input-container {
                flex-direction: column;
            }
            
            .message-input {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">
                <i class="fas fa-comments mr-3"></i>rabbit-talk
            </h1>
            <p class="text-gray-400">Sichere, echte Kommunikation</p>
        </header>

        <!-- Hauptchat-Bereich -->
        <main class="bg-gray-800 rounded-lg shadow-lg">
            <!-- Chat-Nachrichten-Container -->
            <div id="chat-messages" class="chat-container p-6 space-y-4">
                <!-- Willkommensnachricht -->
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-rabbit text-4xl mb-4"></i>
                    <p>Willkommen bei rabbit-talk!</p>
                    <p class="text-sm mt-2">Starte eine sichere Unterhaltung</p>
                </div>
            </div>
            
            <!-- Input-Bereich -->
            <div class="border-t border-gray-700 p-4">
                <div class="flex items-center space-x-3 input-container">
                    <!-- Bildupload Button -->
                    <button id="image-btn" class="btn-touch bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition-colors duration-200">
                        <i class="fas fa-image"></i>
                    </button>
                    
                    <!-- Versteckter File-Input für Bilder -->
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    
                    <!-- Nachrichteneingabe -->
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Nachricht eingeben..." 
                        class="message-input flex-1 bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                        maxlength="1000"
                    >
                    
                    <!-- Send Button -->
                    <button id="send-btn" class="btn-touch bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition-colors duration-200">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Zeichen-Counter -->
                <div class="text-right mt-2">
                    <span id="char-counter" class="text-gray-400 text-sm">0/1000</span>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>© 2024 rabbit-talk - Datenschutz und Sicherheit stehen an erster Stelle</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase-Konfiguration wird automatisch injected
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';

        // Firebase-Konfiguration wird automatisch injected
        const firebaseConfig = {
            // Firebase-Konfiguration wird automatisch injected
        };

        // Firebase initialisieren
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM-Elemente
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const imageBtn = document.getElementById('image-btn');
        const imageUpload = document.getElementById('image-upload');
        const charCounter = document.getElementById('char-counter');

        // Nachrichten in Echtzeit laden
        const q = query(collection(db, 'messages'), orderBy('timestamp', 'asc'));
        onSnapshot(q, (querySnapshot) => {
            // Willkommensnachricht entfernen, wenn erste echte Nachricht kommt
            if (querySnapshot.size > 0) {
                const welcomeMsg = chatMessages.querySelector('.text-center');
                if (welcomeMsg) welcomeMsg.remove();
            }
            
            chatMessages.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const message = doc.data();
                displayMessage(message);
            });
            
            // Scroll zum Ende
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Nachricht anzeigen
        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fade-in bg-gray-700 rounded-lg p-4 max-w-xs ml-auto';
            
            if (message.type === 'image') {
                messageDiv.innerHTML = `
                    <img src="${message.imageUrl}" alt="Geteiltes Bild" class="message-image">
                    ${message.text ? `<p class="mt-2">${escapeHtml(message.text)}</p>` : ''}
                    <p class="text-xs text-gray-400 mt-2">${formatTime(message.timestamp)}</p>
                `;
            } else {
                messageDiv.innerHTML = `
                    <p>${escapeHtml(message.text)}</p>
                    <p class="text-xs text-gray-400 mt-2">${formatTime(message.timestamp)}</p>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
        }

        // Nachricht senden
        async function sendMessage(text = '', imageFile = null) {
            if (!text.trim() && !imageFile) return;
            
            try {
                const messageData = {
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                    type: imageFile ? 'image' : 'text'
                };
                
                // Bild hochladen, falls vorhanden
                if (imageFile) {
                    const imageRef = ref(storage, `images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(imageRef, imageFile);
                    messageData.imageUrl = await getDownloadURL(snapshot.ref);
                }
                
                await addDoc(collection(db, 'messages'), messageData);
                
                // Input leeren
                messageInput.value = '';
                imageUpload.value = '';
                updateCharCounter();
                
            } catch (error) {
                console.error('Fehler beim Senden der Nachricht:', error);
                alert('Fehler beim Senden der Nachricht. Bitte versuche es erneut.');
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInput.value);
            }
        });
        
        imageBtn.addEventListener('click', () => imageUpload.click());
        
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Bildvorschau oder direkt senden
                const text = prompt('Möchtest du einen Text zur Bildnachricht hinzufügen?') || '';
                sendMessage(text, file);
            }
        });
        
        messageInput.addEventListener('input', updateCharCounter);

        // Zeichenzähler aktualisieren
        function updateCharCounter() {
            const length = messageInput.value.length;
            charCounter.textContent = `${length}/1000`;
            
            if (length > 900) {
                charCounter.className = 'text-red-400 text-sm';
            } else if (length > 700) {
                charCounter.className = 'text-yellow-400 text-sm';
            } else {
                charCounter.className = 'text-gray-400 text-sm';
            }
        }

        // Hilfsfunktionen
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Jetzt';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
